-- title:  Jetpac Reloaded
-- author: Blazej Filimonow
-- desc:   Remake of ZX Spectrum Jetpac
-- script: lua

KEY_UP    =0
KEY_DOWN  =1
KEY_LEFT  =2
KEY_RIGHT =3

KEY_COUNT =3

last_button=-1
button_repeats=0

function init()
  Sky:init()
  Spaceman:init()
end

init()

function TIC() 
  if btn(KEY_UP0) then
  end
	
  if btn(KEY_LEFT) then 
    if last_button==KEY_LEFT then
      button_repeats=button_repeats+1
    else
      last_button=2
      button_repeats=1
    end

    if button_repeats==KEY_COUNT then
      Spaceman:movel()
      button_repeats=0
    end
  end

  if btn(KEY_RIGHT) then 
    if last_button==KEY_RIGHT then
      button_repeats=button_repeats+1
    else
      last_button=3
      button_repeats=1
    end
			
    if button_repeats==KEY_COUNT then
      Spaceman:mover()
      button_repeats=0
    end
  end

  cls()
  Sky:tic()
  Sky:draw()
  map(0,0,30,17,0,0,0)
  Spaceman:draw()
end
-- <CODE1>
-- Sky class for drawing moving stars

Sky=
{
  SKY_SPEED=4,
  stars={},
  count
}

function Sky:init()
  for i=1,40 do
    p=
    {
      x=math.random(0,239),
      y=math.random(0,136),
      color=math.random(2,5),
      speed=math.random(1,3)
    }
    table.insert(self.stars,p);
  end
  self.count=0
end

function Sky:tic()
  self.count=(self.count+1)%self.SKY_SPEED
  if self.count==0 then
    for i=1,#self.stars do
      self.stars[i].x=self.stars[i].x-self.stars[i].speed
      if self.stars[i].x<0 then
        self.stars[i].x=239
        self.stars[i].y=math.random(0,128)
        self.stars[i].color=math.random(2,5)
        self.stars[i].speed=math.random(1,3)
      end
    end
  end
end

function Sky:draw()
  for i=1,#self.stars do
    pix(self.stars[i].x,self.stars[i].y,self.stars[i].color)
  end
end
-- </CODE1>

-- <CODE2>
-- Spaceman class

Spaceman=
{
  SPR_SPCMN_WLK=96,
  SPR_SPCMN_FLY=104,
  x=0,
  y=0,
  frame=0,
  dir=0,
  flying=false
}

function Spaceman:init()
  self.x=108
  self.y=104
  self.frame=0
  self.dir=0
  self.flying=false
end

function Spaceman:movel()
  if self.dir==0 then
    self.x=self.x-2
    self.frame=(self.frame+1)%4
  else
    self.dir=0
  end
end

function Spaceman:mover()
  if self.dir==1 then
    self.x=self.x+2
    self.frame=self.frame-1
    if self.frame<0 then
      self.frame=3
    end
  else
    self.dir=1
  end
end

function Spaceman:draw()
  if not self.flying then
    spr(self.SPR_SPCMN_WLK+self.frame*2,
        self.x,self.y,0,1,
        self.dir,0,2,3)
  else
    spr(self.SPR_SPCMN_FLY+self.frame*2,
        self.x,self.y,0,1,
        self.dir,0,2,3)
  end
end

-- </CODE2>

-- <TILES>
-- 001:00b0bbbb0bbbbbbbbbbbbbbbbb0bbb0bbbbbb0bb0bbbb0bb0bbb000b00b0000b
-- 002:b0bbbb0bbbbbbbbbbbbbbbbbbbbb0bbbbbb0b0bbbb0bbb0bb0b0bb0b00000b00
-- 003:0b00bb00bbbbbbb0bbbbbbbb00bbbbb0bbbbbbbbbbbbbbb0b00bbb000000b000
-- 017:00e0eeee0eeeeeeeeeeeeeeeee0eee0eeeeee0ee0eeee0ee0eee000e00e0000e
-- 018:e0eeee0eeeeeeeeeeeeeeeeeeeee0eeeeee0e0eeee0eee0ee0e0ee0e00000e00
-- 019:0e00ee00eeeeeee0eeeeeeee00eeeee0eeeeeeeeeeeeeee0e00eee000000e000
-- 032:0000000f0000000f000000f1000000f100000f1f00000f1f0000f11f0000f111
-- 033:f0000000f0000000ff000000ff000000fff00000fff00000ffff0000111f0000
-- 034:0000f11f0000f11f0000f11f0000f11f0000f11f000ff11f000ff11f00f1f11f
-- 035:ffff0000f1ff000011ff0000f1ff0000111ff000fffff000ffffff0011111f00
-- 036:f1fff11ff1fff11ff1fff11ff1fff11ffffff11ff1f1f11ff1f1f11ff1f1ffff
-- 037:ffff1fffffff1fffffff1fffffff1fffffffffffffff1f1fffff1f1fffff1f1f
-- 038:000000000000000000000000000000000000000f0000000f000000ff00000f00
-- 039:00fff0000fffff00ffff00f0ffff00f0ffff00f0ffff00f0ffff00f0ffff00f0
-- 040:0000f0ff0000f0ff0000ff0f0000f0ff0000f0ff0000f0ff0000f0ff0000ff0f
-- 041:0f0ff0f00f0ff0f00f0f00f00f0f0ff0000f0ff0ffff0ff0ffff0ff0000f0ff0
-- 042:0000ff0f0000f0ff000ff0ff00ff0fff00ff0fff0f0f0fff0f0f0fffff0f0fff
-- 043:0fff0ff00fff0ff00fff0ff00fff0ff00ffffff0fffffff0f00fff00f0f000f0
-- 048:0000f11f0000f11f0000f11f0000f11f0000f11f0000f11f0000f11f0000f11f
-- 049:ffff0000ffff0000ffff0000ffff0000ffff00001f1f00001f1f00001f1f0000
-- 050:00f1f11f0f1ff11f0f1ff11ff111f11ff1fff11ff1fff11ff1fff11ff1fff11f
-- 051:ffff1f00ffff1ff0ffff1ff0ffff111fffff1fffffff1fffffff1fffffff1fff
-- 052:ffff1f11ffff1f1f1f1f1f1f1f1f11f1f111f11ff1fff11ff1fff111f1fff111
-- 053:11f1fffffff1fffffff1f1f1ff11f1f1f11f111ff11f1fff111f1fff111f1fff
-- 054:00000f0000000fff0000ff000000ff000000ffff0000ffff0000f0ff0000f0ff
-- 055:ffff00f0ffff00f0fffff0f0fffff0f0fffff0f0fffff0f0fffff0f0fffff0f0
-- 056:0000f0ff0000f0ff0000f0ff0000f0ff0000ffff0000ffff0000ff000000f0ff
-- 057:ff0f0ff0000f0ff00fff0ff0000f0ff0ffff0ff0ffff0ff00fffff000fff0ff0
-- 058:ff0f0fffff0f0fffff0f0fffff0f0fffff0f0fffff0ffffff0000000f0000000
-- 059:00f0fff000f0000f0f00ffff0f00ffff0f00ffff0f00ffff0f00ffff0f00ffff
-- 064:0000000f0000000f0000000f0000000f0000000f000000f000000f0f0000f000
-- 065:f0000000f0000000f0000000f0000000f00000000f000000fff00000000f0000
-- 066:0fffffffff0ff00fff0ff00ff0f00ff0f0f00ff0fffffffff000f0fff000f0ff
-- 067:fffffff0f00ff0fff00ff0ff0ff00f0f0ff00f0fffffffffffffffffffffffff
-- 068:ff0ff00ff0f00ff0f0f00ff00fffffff0f000f0f0f000f0f0f000f0f0f000f0f
-- 069:f00ff0000ff00f0f0ff00f0ffffffff0fffffff0fffffff0fffffff0fffffff0
-- 070:0000000f0000000f000000ff000000ff000000ff00000fff00000f0f00000f0f
-- 071:f0000000f0000000ff000000ff000000ff000000fff00000f0f00000f0f00000
-- 072:000ff00f000f000f000ff00f000fff0f000fffff000fffff000fffff0000ffff
-- 073:f000f000f000f000f00ff000f0fff000fffff000fffff000fffff000ffff0000
-- 074:f0fff0fffffff0fff0f0f0fff0f0f0fff0f0f0fff000f0fffffff0ffffff00ff
-- 075:ff0fff0fff0fffffff0f0fffff0fffffff0f0f0fff0f000fff0fff0fff00ffff
-- 080:0000f00f0000f00f0000f00f000ffff0000f00ff00f00f0f00f00f0f0f00f0ff
-- 081:ffff0000ffff0000ffff00000000f000fffff000ffffff00ffffff00fffffff0
-- 082:f000f0f0f000f0f0f000f0f0f000f0f0f000f0f0f000f0ffffffffffff0ff00f
-- 083:ff0f000fff0fff0fff0f000fff0fff0f000f000ffffffffffffffffff00ff0ff
-- 084:0fffffff00f0f0000f0fff000f0fff00f00000f0f00ffff0f00ffff0f00ffff0
-- 085:fffffff0000f0f0000f0fff000f0fff00f00000f0f00ffff0f00ffff0f00ffff
-- 086:0000ff0f0000f00f0000f00f000ff0ff000f0f0f000ff00f000f00ff000f0f0f
-- 087:f0ff0000f00f0000f00f0000f00ff000f000f000f000f000f000f000f000f000
-- 088:f000fffff000fffff000fffff00f0ffff00f0ffff00f0ffff0fff0fff0fff0ff
-- 089:ffff000fffff000fffff000ffff0f00ffff0f00ffff0f00fff0fff0fff0fff0f
-- 090:ffff00f0fff00f0ffff00f0fff00f000ff00f00ff000f00ff000f00ff0000000
-- 091:0f00fffffff00ffffff00fff000f00ffffff00ffffff000fffff000f0000000f
-- 096:00000000000000000000000000000000000000ff000000ff000000ff0000000f
-- 097:0000000000000000ffff000022fff000ff1ff00ff1fff00ff1fff00ffff000ff
-- 098:00000000000000000000000000000000000000ff000000ff000000ff0000000f
-- 099:0000000000000000ffff000022fff000ff1ff00ff1fff00ff1fff00ffff000ff
-- 100:00000000000000000000000000000000000000ff000000ff000000ff0000000f
-- 101:0000000000000000ffff000022fff000ff1ff00ff1fff00ff1fff00ffff000ff
-- 102:00000000000000000000000000000000000000ff000000ff000000ff0000000f
-- 103:0000000000000000ffff000022fff000ff1ff00ff1fff00ff1fff00ffff000ff
-- 104:0000000f0000000000000fff00000fff00000fff000000ff000000000000000f
-- 105:fff000000fff0000f0ff0f000fff0f000fff0f00fff00ff000000ff0fff0f0f0
-- 106:0000000f0000000000000fff00000fff00000fff000000ff000000000000000f
-- 107:fff000000fff0000f0ff0f000fff0f000fff0f00fff00ff000000ff0fff0f0f0
-- 108:0000000f0000000000000fff00000fff00000fff000000ff000000000000000f
-- 109:fff000000fff0000f0ff0f000fff0f000fff0f00fff00ff000000ff0fff0f0f0
-- 110:0000000f0000000000000fff00000fff00000fff000000ff000000000000000f
-- 111:fff000000fff0000f0ff0f000fff0f000fff0f00fff00ff000000ff0fff0f0f0
-- 112:000000000000000000000f0f00000f0f00fffff10000000f0000000f0000000f
-- 113:111000ffffff1f1ff11f1ffff11f1f1f111f1ffffff1ff1ffff1fffffffffff0
-- 114:000000000000000000000f0f00000f0f00fffff10000000f0000000f0000000f
-- 115:111000ffffff1f1ff11f1ffff11f1f1f111f1ffffff1ff1ffff1fffffffffff0
-- 116:000000000000000000000f0f00000f0f00fffff10000000f0000000f0000000f
-- 117:111000ffffff1f1ff11f1ffff11f1f1f111f1ffffff1ff1ffff1fffffffffff0
-- 118:000000000000000000000f0f00000f0f00fffff10000000f0000000f0000000f
-- 119:111000ffffff1f1ff11f1ffff11f1f1f111f1ffffff1ff1ffff1fffffffffff0
-- 120:0000f0ff0000f0ff0fffff00000000ff0000000f000fffff000fffff000ff000
-- 121:00f0fff000f0f0f000f0fff0ff0ff0f0ff0ffff0f0ffff00f00f0f0000f0f0f0
-- 122:0000f0ff0000f0ff0fffff00000000ff0000000f000fffff000fffff000ff000
-- 123:00f0fff000f0f0f000f0fff0ff0ff0f0ff0ffff0f0ffff00f00f0f0000f0f0f0
-- 124:0000f0ff0000f0ff0fffff00000000ff0000000f000fffff000fffff000ff000
-- 125:00f0fff000f0f0f000f0fff0ff0ff0f0ff0ffff0f0ffff00f00f0f0000f0f0f0
-- 126:0000f0ff0000f0ff0fffff00000000ff0000000f000fffff000fffff000ff000
-- 127:00f0fff000f0f0f000f0fff0ff0ff0f0ff0ffff0f0ffff00f00f0f0000f0f0f0
-- 128:0000000f0000000f0000000f0000000000000000000000000000000f000000ff
-- 129:fff1f1f0ff0f1f1fff0fffffff00000011000000ff000000ff000000ff000000
-- 130:0000000f0000000f0000000f000000f00000000f000000ff00000fff0000ffff
-- 131:fff1f1f0ff0f1f1fff0ffffffff000000ff0000000ff00000fff0000ffff0000
-- 132:0000000f000000ff000000ff00000ff000000ff00000ff00000fff0000ffff00
-- 133:fff1f1f0ffff1f1fff0ffffffff000000fff000000f0ff00000fff0000fff000
-- 134:0000000f0000000f0000000f000000f00000000f000000ff00000fff0000ffff
-- 135:fff1f1f0ff0f1f1fff0ffffffff000000ff0000000ff00000fff0000ffff0000
-- 136:0000000000fff0000ffff0000000000000000000000000000000000000000000
-- 137:00fffff0000000000000f0f0000fff0000f000f0000ff0ff00000f000000f000
-- 138:0000000000fff0000ffff0000000000000000000000000000000000000000000
-- 139:00fffff00000000000f0ff0f00f00f000000f00f000f00f000000f000000000f
-- 140:0000000000fff0000ffff0000000000000000000000000000000000000000000
-- 141:00fffff00000000000f0f0f000f00f000000fff0000f00ff000000000000ff0f
-- 142:0000000000fff0000ffff0000000000000000000000000000000000000000000
-- 143:00fffff00000000000f0f00f00f000f00000ff0f000f00f000000f000000000f
-- 224:0000000000000000000000000000000000000000000660006666666666666666
-- 225:0000000000000000000000000000000000000000000660006666666666666666
-- 240:6000606060666060600060606066606060666000666666666666666600066000
-- 241:6000606660666066600660666066606660006006666666666666666600066000
-- </TILES>

-- <MAP>
-- 003:000000000000000000000000000000000000000000000001000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:000000000002120000000000000000000000000000000010202020203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:000000000003130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:000000102020202030000000000022320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:000000000000000000000000000023330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:000000000000000000000000001020203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:000062720000041400006474000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:000063730000051500006575000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:000082920000243400008494000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000083930000253500008595000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:0000a2b2000044540000a4b4000000000000004252000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:0000a3b3000045550000a5b5000000000000004353000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:112121212121212121212121212121212121212121212121212121212131000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <PALETTE>
-- 000:140c1c44243430346d4e4a4e854c30346524d04648757161597dced27d2c8595a16daa2cd2aa996dc2cadad45edeeed6
-- </PALETTE>

